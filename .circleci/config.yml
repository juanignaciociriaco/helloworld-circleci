version: 2.1
jobs:
  tests:
    docker:
      - image: circleci/openjdk:8-jdk-stretch
    steps:
      - checkout
      - run:
          name: Versioning
          command: |
            echo 'mvn versions:set -DnewVersion=${CIRCLE_TAG}'
      - run:
          name: Enforcer
          command: |
            echo 'mvn enforcer:enforce'
      - run:
          name: Sonar
          command: |
            echo 'mvn install sonar:sonar'
## This is the second job definition. All commands are "echo"
  checkout_and_build:
    docker:
      - image: circleci/openjdk:8-jdk-stretch
    steps:
      - checkout
      - run:
          name: Versioning
          command: |
            echo 'mvn versions:set -DnewVersion=${CIRCLE_TAG}'
      - run:
          name: Enforcer
          command: |
            echo 'mvn enforcer:enforce'
      - run:
          name: Sonar
          command: |
            echo 'mvn install sonar:sonar'
            echo 'mvn clean deploy -Dmaven.test.skip=true'

## This is the third job definition
  promote_to_master:
    docker:
      - image: circleci/openjdk:8-jdk-stretch
    steps:
      - checkout
      - run:
          name: The First Step
          command: |
            echo 'Hello World!'
            echo 'This is the delivery pipeline'
workflows:
  version: 2
  build_release:
    jobs:
      - checkout_and_build
  promote_to_environments:
    jobs:
      - checkout_and_build
      - promote_to_master:
          requires:
          - checkout_and_build
